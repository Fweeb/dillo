CKEDITOR.plugins.add("floatpanel",{requires:"panel"});(function(){var a={};function b(g,h,d,f,i){var e=CKEDITOR.tools.genKey(h.getUniqueId(),d.getUniqueId(),g.lang.dir,g.uiColor||"",f.css||"",i||""),c=a[e];if(!c){c=a[e]=new CKEDITOR.ui.panel(h,f);c.element=d.append(CKEDITOR.dom.element.createFromHtml(c.render(g),h));c.element.setStyles({display:"none",position:"absolute"})}return c}CKEDITOR.ui.floatPanel=CKEDITOR.tools.createClass({$:function(j,l,e,d){e.forceIFrame=1;if(e.toolbarRelated&&j.elementMode==CKEDITOR.ELEMENT_MODE_INLINE){l=CKEDITOR.document.getById("cke_"+j.name)}var k=l.getDocument(),c=b(j,k,l,e,d||0),g=c.element,f=g.getFirst(),i=this;g.disableContextMenu();this.element=g;this._={editor:j,panel:c,parentElement:l,definition:e,document:k,iframe:f,children:[],dir:j.lang.dir};j.on("mode",h);j.on("resize",h);if(!CKEDITOR.env.iOS){k.getWindow().on("resize",h)}function h(){i.hide()}},proto:{addBlock:function(c,d){return this._.panel.addBlock(c,d)},addListBlock:function(c,d){return this._.panel.addListBlock(c,d)},getBlock:function(c){return this._.panel.getBlock(c)},showBlock:function(u,c,i,r,q,f){var m=this._.panel,k=m.showBlock(u);this.allowBlur(false);var p=this._.editor.editable();this._.returnFocus=p.hasFocus?p:new CKEDITOR.dom.element(CKEDITOR.document.$.activeElement);this._.hideTimeout=0;var d=this.element,j=this._.iframe,l=CKEDITOR.env.ie?j:new CKEDITOR.dom.window(j.$.contentWindow),t=d.getDocument(),h=this._.parentElement.getPositionedAncestor(),s=c.getDocumentPosition(t),n=h?h.getDocumentPosition(t):{x:0,y:0},g=this._.dir=="rtl",e=s.x+(r||0)-n.x,o=s.y+(q||0)-n.y;if(g&&(i==1||i==4)){e+=c.$.offsetWidth}else{if(!g&&(i==2||i==3)){e+=c.$.offsetWidth-1}}if(i==3||i==4){o+=c.$.offsetHeight-1}this._.panel._.offsetParentId=c.getId();d.setStyles({top:o+"px",left:0,display:""});d.setOpacity(0);d.getFirst().removeStyle("width");this._.editor.focusManager.add(l);if(!this._.blurSet){CKEDITOR.event.useCapture=true;l.on("blur",function(v){if(!this.allowBlur()||v.data.getPhase()!=CKEDITOR.EVENT_PHASE_AT_TARGET){return}if(this.visible&&!this._.activeChild){if(CKEDITOR.env.iOS){if(!this._.hideTimeout){this._.hideTimeout=CKEDITOR.tools.setTimeout(w,0,this)}}else{w.call(this)}}function w(){delete this._.returnFocus;this.hide()}},this);l.on("focus",function(){this._.focused=true;this.hideChild();this.allowBlur(true)},this);if(CKEDITOR.env.iOS){l.on("touchstart",function(){clearTimeout(this._.hideTimeout)},this);l.on("touchend",function(){this._.hideTimeout=0;this.focus()},this)}CKEDITOR.event.useCapture=false;this._.blurSet=1}m.onEscape=CKEDITOR.tools.bind(function(v){if(this.onEscape&&this.onEscape(v)===false){return false}},this);CKEDITOR.tools.setTimeout(function(){var v=CKEDITOR.tools.bind(function(){var N=d;N.removeStyle("width");if(k.autoSize){var B=k.element.getDocument();var G=(CKEDITOR.env.webkit?k.element:B.getBody()).$.scrollWidth;if(CKEDITOR.env.ie&&CKEDITOR.env.quirks&&G>0){G+=(N.$.offsetWidth||0)-(N.$.clientWidth||0)+3}G+=10;N.setStyle("width",G+"px");var D=k.element.$.scrollHeight;if(CKEDITOR.env.ie&&CKEDITOR.env.quirks&&D>0){D+=(N.$.offsetHeight||0)-(N.$.clientHeight||0)+3}N.setStyle("height",D+"px");m._.currentBlock.element.setStyle("display","none").removeStyle("display")}else{N.removeStyle("height")}if(g){e-=d.$.offsetWidth}d.setStyle("left",e+"px");var E=m.element,K=E.getWindow(),z=d.$.getBoundingClientRect(),A=K.getViewPaneSize();var x=z.width||z.right-z.left,I=z.height||z.bottom-z.top;var H=g?z.right:A.width-z.left,L=g?A.width-z.right:z.left;if(g){if(H<x){if(L>x){e+=x}else{if(A.width>x){e=e-z.left}else{e=e-z.right+A.width}}}}else{if(H<x){if(L>x){e-=x}else{if(A.width>x){e=e-z.right+A.width}else{e=e-z.left}}}}var y=A.height-z.top,C=z.top;if(y<I){if(C>I){o-=I}else{if(A.height>I){o=o-z.bottom+A.height}else{o=o-z.top}}}if(CKEDITOR.env.ie){var w=new CKEDITOR.dom.element(d.$.offsetParent),F=w;if(F.getName()=="html"){F=F.getDocument().getBody()}if(F.getComputedStyle("direction")=="rtl"){if(CKEDITOR.env.ie8Compat){e-=d.getDocument().getDocumentElement().$.scrollLeft*2}else{e-=(w.$.scrollWidth-w.$.clientWidth)}}}var J=d.getFirst(),M;if((M=J.getCustomData("activePanel"))){M.onHide&&M.onHide.call(this,1)}J.setCustomData("activePanel",this);d.setStyles({top:o+"px",left:e+"px"});d.setOpacity(1);f&&f()},this);m.isLoaded?v():m.onLoad=v;CKEDITOR.tools.setTimeout(function(){var w=CKEDITOR.env.webkit&&CKEDITOR.document.getWindow().getScrollPosition().y;this.focus();k.element.focus();if(CKEDITOR.env.webkit){CKEDITOR.document.getBody().$.scrollTop=w}this.allowBlur(true);this._.editor.fire("panelShow",this)},0,this)},CKEDITOR.env.air?200:0,this);this.visible=1;if(this.onShow){this.onShow.call(this)}},focus:function(){if(CKEDITOR.env.webkit){var d=CKEDITOR.document.getActive();d&&!d.equals(this._.iframe)&&d.$.blur()}var c=this._.lastFocused||this._.iframe.getFrameDocument().getWindow();c.focus()},blur:function(){var d=this._.iframe.getFrameDocument(),c=d.getActive();c&&c.is("a")&&(this._.lastFocused=c)},hide:function(d){if(this.visible&&(!this.onHide||this.onHide.call(this)!==true)){this.hideChild();CKEDITOR.env.gecko&&this._.iframe.getFrameDocument().$.activeElement.blur();this.element.setStyle("display","none");this.visible=0;this.element.getFirst().removeCustomData("activePanel");var c=d&&this._.returnFocus;if(c){if(CKEDITOR.env.webkit&&c.type){c.getWindow().$.focus()}c.focus()}delete this._.lastFocused;this._.editor.fire("panelHide",this)}},allowBlur:function(d){var c=this._.panel;if(d!==undefined){c.allowBlur=d}return c.allowBlur},showAsChild:function(d,e,g,f,c,h){if(this._.activeChild==d&&d._.panel._.offsetParentId==g.getId()){return}this.hideChild();d.onHide=CKEDITOR.tools.bind(function(){CKEDITOR.tools.setTimeout(function(){if(!this._.focused){this.hide()}},0,this)},this);this._.activeChild=d;this._.focused=false;d.showBlock(e,g,f,c,h);this.blur();if(CKEDITOR.env.ie7Compat||CKEDITOR.env.ie6Compat){setTimeout(function(){d.element.getChild(0).$.style.cssText+=""},100)}},hideChild:function(d){var c=this._.activeChild;if(c){delete c.onHide;delete this._.activeChild;c.hide();d&&this.focus()}}}});CKEDITOR.on("instanceDestroyed",function(){var d=CKEDITOR.tools.isEmpty(CKEDITOR.instances);for(var e in a){var c=a[e];if(d){c.destroy()}else{c.element.hide()}}d&&(a={})})})();