{% extends 'layout.html' %}
{% block page_title %}
	{% if title == 'index_category' %}
		{{category}}
	{% else %}
		All
	{% endif %}
{% endblock%}

{% block body %}
<h3>{% if title == 'index_category' %}
			<a href="{{url_for('posts.index')}}">All</a>
			<strong>Â·</strong>
			<a href="{{url_for('index')}}{{category}}" class="text-capitalize">{{category}}</a>
		{% else %}
			All
		{% endif %}

		<span class="badge">({{posts|length}})</span>
</h3>

<div class="row post-index">
	<div class="col-md-9">
		{% for post in posts %}
		<div class="row post-index-item
								{{ loop.cycle('odd', 'even') }}">
			<div class="col-md-2 col-sm-2 col-xs-2">
				<div class="post-index-item-rate" title="{{post.rating.positive}} Upvotes, {{post.rating.negative}} Downvotes">
					<a class="up{% if post.user_rating and post.user_rating.is_positive %} rated{% endif %}" href="{{url_for('posts.rate', uuid=post.uuid, rating='1')}}" title="Upvote, click again to undo">
						<i class="fa fa-angle-up"></i>
					</a>
					<span class="middle">{{post.rating_delta}}</span>
					<a class="down{% if post.user_rating and not post.user_rating.is_positive %} rated{% endif %}" href="{{url_for('posts.rate', uuid=post.uuid, rating='0')}}" title="Downvote, click again to undo">
						<i class="fa fa-angle-down"></i>
					</a>
				</div>
				<a href="
						{% if post.post_type.url == 'link' %}
							{{post.content}}
						{% else %}
							{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}
						{% endif %}">
					<div class="post-index-item-type {{post.post_type.url}}"
					  {% if post.picture %}style="background: url({{post.thumbnail('s')}}) top left no-repeat"{% endif %}>
						{% if post.post_type.url == 'link' %}
							<i class="fa fa-link"></i>
						{% elif post.post_type.url == 'text' %}
							<i class="fa fa-file-text-o"></i>
						{% endif %}
					</div>
				</a>
			</div>

			<div class="col-md-10 col-sm-10 col-xs-10">

				<a class="post-index-item-title"
					 href="
					 {% if post.post_type.url == 'link' %}
					 	{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}
					 {% else %}
					 	{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}
					 {% endif %}
					 "
					 title="{{post.title}}">
					{{post.title}}
				</a>

				<div class="post-index-item-details" href="{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}">
					<a href="{{url_for('index')}}{{post.category.url}}">{{post.category}}</a>
					<span class="separator"></span>
					<a href="{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}#comments">
						{{post.comments|length}} comments
					</a>
					<span class="separator"></span>
					<span title="{{post.creation_date.strftime('%H:%M on %d %B, %Y')}}">
						{{post.pretty_creation_date}}
					</span>

					<small>by</small>
					<a href="{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}#comments">
						{{post.user.first_name}} {{post.user.last_name}}
					</a>

					{% if post.picture %}
					<span class="separator"></span>
					<span class="post-index-item-picture-collapse"><i class="fa fa-minus"></i></span>
					<span class="post-index-item-picture-expand"><i class="fa fa-picture-o"></i></span>
					<img class="post-index-item-picture"
							 title="Click and drag to resize"
							 data-rel="{{post.thumbnail('l')}}" src=""/>
					{% endif %}

				</div>
			</div>
		</div>
		{% endfor %}
		<div class="post-index-end"><i class="bf-blender"></i></div>
	</div>
</div>
{% endblock %}

{% block footer_scripts %}
<script type="text/javascript">

	$('.post-index-item-picture-expand').click(function(){
		$(this).next($('.post-index-item-picture')).attr('src', $(this).next().data('rel'));
		$(this).next($('.post-index-item-picture')).css('display', 'block');
		$(this).next($('.post-index-item-picture')).animate({'opacity': 1.0});
		$(this).fadeOut('fast', function(){
			$(this).prev().fadeIn('fast');
		});
	});

	$('.post-index-item-picture-collapse').click(function(){
		$(this).next().next().fadeOut('fast');
		$(this).fadeOut('fast', function(){
			$(this).next().fadeIn('fast');
		});
	});

	$('.post-index-item-picture').mousedown(function(e){
		e.preventDefault();

		image = $(this);

		$(document).mousemove(function(e){
			e.preventDefault();
			var x = ((e.pageX - image.parent().offset().left) + (image.width())) * 0.6;
			$(image).css("width", x);
		})
	});

	$(document).mouseup(function(e){
		$(document).unbind('mousemove');
	});

	$(".up").click(function(e) {
		e.preventDefault();
		var up = $(this);
		var rate = $(this).next();
		var down = $(this).next().next();
		$.get($(this).attr("href"), function(data){
			down.removeClass('rated');
			if (data['rating'] === "True") {
				up.addClass('rated');
			} else {
				up.removeClass('rated');
			}
			rate.text(data['rating_delta']);
		});
	});
	$(".down").click(function(e) {
		e.preventDefault();
		var up = $(this).prev().prev();
		var rate = $(this).prev();
		var down = $(this);
		$.get($(this).attr("href"), function(data){
			up.removeClass('rated');
			if (data['rating'] === "False") {
				$(".down").addClass('rated');
			} else {
				$(".down").removeClass('rated');
			}
			rate.text(data['rating_delta']);
		});
	});

</script>
{% endblock %}
