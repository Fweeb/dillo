{% extends 'layout.html' %}
{% from 'posts/_macros.html' import category_dropdown %}

{% block og %}
	<meta property="og:type" content="website" />
	<meta property="og:title" content="Blender.Today" />
	<meta property="og:url" content="http://blender.today" />
	<meta property="og:image" content="{{ url_for('static', filename='images/favicon_192x192.png') }}" />
{% endblock %}

{% block page_title %}
	{% if title == 'index_category' %}
		{{category}}
	{% endif %}
{% endblock%}

{% block body %}

{# Heavy caching starts here #}
{% cache 60*5, 'post_list', user_string_id, category_url, page %}
<div class="row">
	<div class="col-md-9 post-index">
		<div class="row">
			<div class="col-md-6 col-xs-6">
				<h4>
					{% if title == 'index_category' %}
						<a href="{{url_for('posts.index')}}">Home</a>
						<strong>·</strong>
						<a href="{{url_for('posts.index_category', category=category.url)}}">{{category.name}}</a>
					{% else %}
						<a href="{{url_for('posts.index')}}">Home</a>
					{% endif %}
						<span class="badge">({{posts.items|length}})</span>
				</h4>
			</div>
			<div class="col-md-6 col-xs-6">
				{{ category_dropdown(title, category, categories) }}
			</div>
		</div> <!-- row -->

		{% if posts.items %}
			{% for post in posts.items %}
			<div class="row">
				<div class="col-md-12">
					<div class="post-index-item {{ loop.cycle('odd', 'even') }}">

						{# Post Rating #}
						<div class="post-index-item-rate{% if current_user.is_anonymous() %} popover-vote{% endif %}" title="{{post.rating.positive}} Upvotes, {{post.rating.negative}} Downvotes" {% if current_user.is_anonymous() %} data-toggle="popover" data-trigger="hover" data-placement="bottom" data-content="Please login to vote" {% endif %}>
							<a class="up{% if post.user_rating and post.user_rating.is_positive %} rated{% endif %}" href="{{url_for('posts.rate', uuid=post.uuid, rating='1')}}" title="Upvote, click again to undo">
								<i class="fa fa-angle-up"></i>
							</a>
							<span class="middle">{{post.rating_delta}}</span>
							<a class="down{% if post.user_rating and not post.user_rating.is_positive %} rated{% endif %}" href="{{url_for('posts.rate', uuid=post.uuid, rating='0')}}" title="Downvote, click again to undo">
								<i class="fa fa-angle-down"></i>
							</a>
						</div>

						{# Post circle thingie #}
						<a href="{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}" title="View post and comments">
							<div class="post-index-item-type {{post.post_type.url}}" {% if post.picture %}style="background: url({{post.thumbnail('s')}}) top left no-repeat"{% endif %}>

								{% if not post.picture %}
									{% if post.post_type.url == 'link' %}
										<i class="fa fa-link"></i>
									{% elif post.post_type.url == 'text' %}
										<i class="fa fa-file-text-o"></i>
									{% endif %}
								{% endif %}
							</div>
						</a>

						<a class="post-index-item-title"
							href="{% if post.post_type.url == 'link' %}{{post.content}}{% else %}{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}{% endif %}"
							title="{{post.title}}"
							{% if post.post_type.url == 'link' %}target="_blank"{% endif %}>
							{{post.title}}
						</a>

						<div class="post-index-item-details" href="{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}">

							<a href="{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}" class="post-index-item-details-type">
								{{post.post_type}}
							</a>

							<span class="separator"></span>

							<a href="{{url_for('index')}}{{post.category.url}}">{{post.category}}</a>

							<span class="separator"></span>

							<a href="{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}#comments" class="post-index-item-details-comments">
								<span class="hidden-xs">
								{% if post.comments_count == 0 %}
									Comment
								{% elif post.comments_count == 1 %}
									1 comment
								{% else %}
									{{post.comments_count}} comments
								{% endif %}
								</span>
								{% if post.comments_count > 0 %}
									<span class="visible-xs">
										{{post.comments_count}} <i class="fa fa-comments-o"></i>
									</span>
								{% endif %}
							</a>

							<span class="separator hidden-xs"></span>

							{{post.pretty_creation_date}}

							<small>by</small>
							{% if post.user.deleted %}
								<span class="deleted" title="This account no longer exists">[deleted]</span>
							{% else %}
								<a href="{{url_for('index')}}u/{{post.user.id}}">
									{{post.user.username}}
								</a>
							{% endif %}

							{% if post.picture %}

							<span class="post-index-item-picture-collapse" title="Collapse"><i class="fa fa-minus-square-o"></i></span>
							<span class="post-index-item-picture-expand" title="Expand"><i class="fa fa-plus-square-o"></i></span>
							<img class="post-index-item-picture"
									 title="Click and drag to resize"
									 data-rel="{{post.thumbnail('l')}}" src=""/>
							{% endif %}

						</div>
						<div class="clearfix"></div>
					</div> <!-- post-index-item -->
				</div> <!-- col-md -->
			</div> <!-- row -->
			{% endfor %}
		{% else %}
			<div class="post-index-empty">
				<h3>Nothing to see here... yet.</h3>
				<h4>It's your chance, submit stuff!</h4>
			</div>
		{% endif %}

		<div class="row text-center">
			<div class="col-md-12">
				<nav>
					<ul class="pagination">
						{% if posts.has_prev %}
							<li><a href="{{ url_for('posts.index', page=posts.page-1) }}"><i class="fa fa-arrow-left"></i></a></li>
						{% else %}
							<li class="disabled"><a><i class="fa fa-arrow-left"></i></a></li>
						{% endif %}

						{% for post in posts.iter_pages() %}
							{% if post %}
								{% if post != posts.page %}
									<li><a href="{{ url_for('posts.index', page=post) }}">{{ post }}</a><li>
								{% else %}
									<li class="active"><a href="#">{{ post }}</a></li>
								{% endif %}
							{% else %}
								<span class="ellipsis">…</span>
							{% endif %}
						{% endfor %}

						{% if posts.has_next %}
							<li><a href="{{ url_for('posts.index', page=posts.page+1) }}"><i class="fa fa-arrow-right"></i></a></li>
						{% else %}
							<li class="disabled"><a><i class="fa fa-arrow-right"></i></a></li>
						{% endif %}
					</ul>
				</nav>
			</div><!-- col-md -->

		</div>

	</div> <!--row -->
	<div class="col-md-3">
		{% include '_sidebar.html' %}
	</div>
</div><!-- row -->

{% endcache %}
{# Heavy caching ends here #}

{% endblock %}

{% block footer_scripts %}
<script type="text/javascript">

	$(".up").click(function(e) {
		e.preventDefault();
		var up = $(this);
		var rate = $(this).next();
		var down = $(this).next().next();
		$.get($(this).attr("href"), function(data){
			down.removeClass('rated');
			if (data['rating'] === "True") {
				up.addClass('rated');
			} else {
				up.removeClass('rated');
			}
			rate.text(data['rating_delta']);
		});
	});
	$(".down").click(function(e) {
		e.preventDefault();
		var up = $(this).prev().prev();
		var rate = $(this).prev();
		var down = $(this);
		$.get($(this).attr("href"), function(data){
			up.removeClass('rated');
			if (data['rating'] === "False") {
				$(".down").addClass('rated');
			} else {
				$(".down").removeClass('rated');
			}
			rate.text(data['rating_delta']);
		});
	});

	{% if current_user.is_anonymous() %}
		$('.popover-vote').popover();
	{% endif %}

</script>
{% endblock %}
