{% extends 'layout.html' %}
{% from 'posts/_macros.html' import category_dropdown %}

{% block page_title %}
	{% if title == 'index_category' %}
		{{category}}
	{% endif %}
{% endblock%}

{% block body %}

{# Heavy caching starts here #}
{% cache 60*5, 'post_list', user_string_id, category_url, page %}
<div class="row">
	<div class="col-md-9 post-index">
		<div class="row">
			<div class="col-md-6">
				<h4>
					{% if title == 'index_category' %}
						<a href="{{url_for('posts.index')}}">Home</a>
						<strong>·</strong>
						<a href="{{url_for('posts.index_category', category=category.url)}}">{{category.name}}</a>
					{% else %}
						<a href="{{url_for('posts.index')}}">Home</a>
					{% endif %}
						<span class="badge">({{posts.items|length}})</span>
				</h4>
			</div>
			<div class="col-md-6">
				{{ category_dropdown(title, category, categories) }}
			</div>
		</div>

		{% if posts.items %}
			{% for post in posts.items %}
			<div class="row post-index-item {{ loop.cycle('odd', 'even') }}">
				<div class="col-lg-2 col-md-2 col-sm-2 col-xs-1">

					{# Post Rating #}
					<div class="post-index-item-rate{% if current_user.is_anonymous() %} popover-vote{% endif %}" title="{{post.rating.positive}} Upvotes, {{post.rating.negative}} Downvotes" {% if current_user.is_anonymous() %} data-toggle="popover" data-trigger="hover" data-placement="bottom" data-content="Please login to vote" {% endif %}>
						<a class="up{% if post.user_rating and post.user_rating.is_positive %} rated{% endif %}" href="{{url_for('posts.rate', uuid=post.uuid, rating='1')}}" title="Upvote, click again to undo">
							<i class="fa fa-angle-up"></i>
						</a>
						<span class="middle">{{post.rating_delta}}</span>
						<a class="down{% if post.user_rating and not post.user_rating.is_positive %} rated{% endif %}" href="{{url_for('posts.rate', uuid=post.uuid, rating='0')}}" title="Downvote, click again to undo">
							<i class="fa fa-angle-down"></i>
						</a>
					</div>

					{# Post circle thingie #}
					<a href="{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}"
						 class="hidden-xs">
						<div class="post-index-item-type {{post.post_type.url}}" {% if post.picture %}style="background: url({{post.thumbnail('s')}}) top left no-repeat"{% endif %}>
							{% if post.post_type.url == 'link' %}
								<i class="fa fa-link"></i>
							{% elif post.post_type.url == 'text' %}
								<i class="fa fa-file-text-o"></i>
							{% endif %}
						</div>
					</a>

				</div>

				<div class="col-lg-10 col-md-10 col-sm-10 col-xs-11">

					<a class="post-index-item-title"
						href="{% if post.post_type.url == 'link' %}{{post.content}}{% else %}{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}{% endif %}"
						title="{{post.title}}"
						{% if post.post_type.url == 'link' %}target="_blank"{% endif %}>
						{{post.title}}
					</a>

					<div class="post-index-item-details" href="{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}">
						{% if post.picture %}
						<span class="post-index-item-picture-collapse"><i class="fa fa-minus"></i></span>
						<span class="post-index-item-picture-expand"><i class="fa fa-picture-o"></i></span>
						<img class="post-index-item-picture"
								 title="Click and drag to resize"
								 data-rel="{{post.thumbnail('l')}}" src=""/>
						<span class="separator"></span>
						{% endif %}


						<a href="{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}">
							{{post.post_type}}
						</a>
						<span class="separator"></span>
						<a href="{{url_for('index')}}{{post.category.url}}">{{post.category}}</a>
						<span class="separator"></span>
						<a href="{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}#comments">
							{{post.comments_count}} comments
						</a>
						<span class="separator"></span>

						{{post.pretty_creation_date}}

						<small>by</small>
						<a href="{{url_for('posts.view', category=post.category.url, uuid=post.uuid, slug=post.slug)}}#comments">
							{% if post.user.first_name %}
								{{post.user.first_name}} {{post.user.last_name}}
							{% else %}
								{{post.user.username}}
							{% endif %}
						</a>
					</div>
				</div>
			</div>
			{% endfor %}
		{% else %}
			<div class="post-index-empty">
				<h3>Nothing to see here... yet.</h3>
				<h4>It's your chance, submit stuff!</h4>
			</div>
		{% endif %}


		<div class="row text-center">
			<div class="col-md-12">
				<nav>
					<ul class="pagination">
						{% if posts.has_prev %}
							<li><a href="{{ url_for('posts.index', page=posts.page-1) }}"><i class="fa fa-arrow-left"></i></a></li>
						{% else %}
							<li class="disabled"><a><i class="fa fa-arrow-left"></i></a></li>
						{% endif %}

						{% for post in posts.iter_pages() %}
							{% if post %}
								{% if post != posts.page %}
									<li><a href="{{ url_for('posts.index', page=post) }}">{{ post }}</a><li>
								{% else %}
									<li class="active"><a href="#">{{ post }}</a></li>
								{% endif %}
							{% else %}
								<span class="ellipsis">…</span>
							{% endif %}
						{% endfor %}

						{% if posts.has_next %}
							<li><a href="{{ url_for('posts.index', page=posts.page+1) }}"><i class="fa fa-arrow-right"></i></a></li>
						{% else %}
							<li class="disabled"><a><i class="fa fa-arrow-right"></i></a></li>
						{% endif %}
					</ul>
				</nav>
			</div>
		</div>

		<!-- <div class="post-index-end"><i class="bf-blender"></i></div> -->
	</div>
	<div class="col-md-3">
		{% include '_sidebar.html' %}
	</div>
</div>

{% endcache %}
{# Heavy caching ends here #}

{% endblock %}

{% block footer_scripts %}
<script type="text/javascript">

	$('.post-index-item-picture-expand').click(function(){
		$(this).next($('.post-index-item-picture')).attr('src', $(this).next().data('rel'));
		$(this).next($('.post-index-item-picture')).css('display', 'block');
		$(this).next($('.post-index-item-picture')).animate({'opacity': 1.0});
		$(this).fadeOut('fast', function(){
			$(this).prev().fadeIn('fast');
		});
	});

	$('.post-index-item-picture-collapse').click(function(){
		$(this).next().next().fadeOut('fast');
		$(this).fadeOut('fast', function(){
			$(this).next().fadeIn('fast');
		});
	});

	$('.post-index-item-picture').mousedown(function(e){
		e.preventDefault();

		image = $(this);

		$(document).mousemove(function(e){
			e.preventDefault();
			var x = ((e.pageX - image.parent().offset().left) + (image.width())) * 0.6;
			$(image).css("width", x);
		})
	});

	$(document).mouseup(function(e){
		$(document).unbind('mousemove');
	});

	$(".up").click(function(e) {
		e.preventDefault();
		var up = $(this);
		var rate = $(this).next();
		var down = $(this).next().next();
		$.get($(this).attr("href"), function(data){
			down.removeClass('rated');
			if (data['rating'] === "True") {
				up.addClass('rated');
			} else {
				up.removeClass('rated');
			}
			rate.text(data['rating_delta']);
		});
	});
	$(".down").click(function(e) {
		e.preventDefault();
		var up = $(this).prev().prev();
		var rate = $(this).prev();
		var down = $(this);
		$.get($(this).attr("href"), function(data){
			up.removeClass('rated');
			if (data['rating'] === "False") {
				$(".down").addClass('rated');
			} else {
				$(".down").removeClass('rated');
			}
			rate.text(data['rating_delta']);
		});
	});

	{% if current_user.is_anonymous() %}
		$('.popover-vote').popover();
	{% endif %}

</script>
{% endblock %}
